#!/usr/bin/env ruby

require_relative "../lib/kindle"
require 'highline/import'

puts ">> Kindle Highlights Fetcher::::::::::::::::::::::::::::::::::::::::"
kindle = Kindle::Account.new
login = kindle.settings.username

if login
  puts "Using Amazon username: #{login}"
else
  ask("Enter your Amazon username:  ") { |q| q.echo = true } unless login = ARGV[0]
end
passwd = ask("Enter your Amazon password (This is not stored):  ") { |q| q.echo = "â€¢" }

begin
  kindle.login = login
  kindle.password = passwd
  k = kindle.highlights
  puts "Getting your kindle highlights..."
  highlights = k.fetch_highlights
  # TODO: Pass in something to bide our time
  # TODO: Multiple output formats. CSV, JSON, Pretty, HTML?
  highlights.each do |highlight|
    puts "#{highlight.asin};#{highlight.title};#{highlight.author};#{highlight.highlight}"
  end
rescue => ex
  # TODO Actually handle this!
  puts ex
  puts "Crud, something went wrong..."
end
